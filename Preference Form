
%%[
	var @messageContext,@contactKey,@firstName,@lastName
	var @monthlyNewsletter,@AdvocacyNewsletter,@researchNewsletter,@chapterUpdates
  var @settingsObject,@publicationLists,@contactFields,@referrer,@agent

  Set @publicationLists = LookupOrderedRows("Publication Lists",-1,"Order","Active",1);

	Set @messageContext = [_messagecontext]
  Set @agent = HTTPRequestHeader('User-Agent')
  Set @referrer = HTTPRequestHeader('Referer')
  Set @host = HTTPRequestHeader('Host')

  Set @contactFields = 'Id, FirstName,LastName'

  FOR @publicationListIndex = 1 TO RowCount(@publicationLists) DO
    Set @ContactFields = Concat(Iif(Empty(@ContactFields),"",Concat(@ContactFields,",")),Field(Row(@publicationLists,@publicationListIndex),"CRM_Field_Name"))
  NEXT @publicationListIndex

]%%

<script runat=server>
	Platform.Load("Core","1");

  var responseObject = {};

	try
	{

		Variable.SetValue("@contactKey",Platform.Request.GetQueryStringParameter('contactKey'));
</script>

%%[
	Set @rs= RetrieveSalesforceObjects('Contact', @contactFields, 'Id', '=', @contactKey);
  Set @settingsObject = "[";
  IF RowCount(@rs) > 0 THEN

    FOR @publicationListIndex = 1 TO RowCount(@publicationLists) DO
      Set @publicationListTitle = Field(Row(@publicationLists,@publicationListIndex),"Title")
      Set @publicationListCRMFieldName = Field(Row(@publicationLists,@publicationListIndex),"CRM_Field_Name")
      Set @publicationListValue = Field(Row(@rs,1),@publicationListCRMFieldName)
      //Add object to array
      Set @settingsObject = Concat(@settingsObject,"{""Title"":""",@publicationListTitle,""",""Value"":""",@publicationListValue,"""}",Iif(@publicationListIndex == RowCount(@publicationLists),"",","))
    NEXT @publicationListIndex

		Set @firstName = Field(Row(@rs,1),'FirstName');
		Set @lastName = Field(Row(@rs,1),'LastName');
  ENDIF
  Set @settingsObject = Concat(@settingsObject,"]");
]%%

<script runat=server>
    responseObject.contactKey = Variable.GetValue("@contactKey");
    responseObject.firstName = Variable.GetValue("@firstName");
    responseObject.lastName = Variable.GetValue("@lastName");
    eval("responseObject.publicationListSettings = " + Variable.GetValue("@settingsObject"));
    Platform.Response.Write(Stringify(responseObject));
	}
	catch(e)
	{
		Platform.Response.Write("Error:" + e.message);
	}
</script>

<html>
<head>
  <meta http-equiv="pragma" content="no-cache" />
</head>

<h3>Debug</h3>
<b>Contact Key Passed:</b>&nbsp;&nbsp; %%=V(@contactKey)=%%</br></br>
<b>Contact Fields:</b>&nbsp;&nbsp;  %%=V(@ContactFields)=%%</br></br>
<b>Rows Returned:</b>&nbsp;&nbsp;  %%=RowCount(@rs)=%%</br></br>
<b>Result Object String:</b>&nbsp;&nbsp; %%=V(@settingsObject)=%%</br></br>
<b>Referrer:</b> &nbsp;&nbsp; %%=V(@referrer)=%%</br></br>
<b>Host:</b> &nbsp;&nbsp; %%=V(@host)=%%</br></br>
<b>Agent:</b> &nbsp;&nbsp; %%=V(@agent)=%%</br></br>
<b>Message Context:</b> &nbsp;&nbsp; %%=V(@messageContext)=%%</br></br>

TEST 9
</html>
